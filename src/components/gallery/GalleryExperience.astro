---
import PhotoLightbox from "@/components/lightbox/PhotoLightbox.astro";
import type { PhotoViewModel } from "@/types/photo";
import { withBase } from "@/utils/withBase";

interface Props {
  photos: PhotoViewModel[];
  tags: string[];
}

const { photos, tags } = Astro.props;
const serializedPhotos = JSON.stringify(photos);
---

<section class="mx-auto w-full max-w-7xl px-5 py-8 md:px-8 md:py-12">
  {tags.length > 0 && (
    <nav class="mb-8 flex flex-wrap gap-2" aria-label="Filter by tag">
      <button
        type="button"
        class="tag-pill rounded-full border border-accent bg-accent/15 px-4 py-1.5 text-sm text-accent transition-colors"
        data-tag=""
        aria-pressed="true"
      >
        All
      </button>
      {tags.map((tag) => (
        <button
          type="button"
          class="tag-pill rounded-full border border-white/15 px-4 py-1.5 text-sm text-muted transition-colors hover:border-accent/40 hover:text-accent"
          data-tag={tag}
          aria-pressed="false"
        >
          {tag}
        </button>
      ))}
    </nav>
  )}

  {
    photos.length > 0 ? (
      <div id="photo-grid" class="masonry-grid">
        {photos.map((photo) => (
          <article
            class="group relative overflow-hidden rounded-xl border border-white/10 bg-surface/80"
            data-photo-card
            data-animate
            data-photo-id={photo.id}
            data-tags={photo.tags.join("|")}
          >
            <button
              class="w-full cursor-pointer text-left"
              type="button"
              data-open-lightbox={photo.id}
              aria-label={`Open ${photo.title}`}
            >
              <div class="relative overflow-hidden">
                <img
                  src={photo.thumbnail.src}
                  width={photo.thumbnail.width}
                  height={photo.thumbnail.height}
                  alt={photo.title}
                  loading="lazy"
                  class="w-full object-cover transition-transform duration-slow group-hover:scale-[1.04]"
                />
                {photo.featured && (
                  <span class="absolute left-3 top-3 z-10 rounded-full bg-accent px-3 py-1 text-xs font-medium text-black">
                    Featured
                  </span>
                )}
                <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent opacity-0 transition-opacity duration-medium group-hover:opacity-100" />
                <div class="absolute inset-x-0 bottom-0 translate-y-2 p-4 opacity-0 transition-all duration-medium group-hover:translate-y-0 group-hover:opacity-100">
                  <p class="font-display text-lg leading-snug text-white">{photo.title}</p>
                  {photo.tags.length > 0 && (
                    <div class="mt-2 flex flex-wrap gap-1.5">
                      {photo.tags.slice(0, 3).map((tag) => (
                        <span class="rounded-full bg-white/15 px-2 py-0.5 text-[11px] text-white/80 backdrop-blur-sm">{tag}</span>
                      ))}
                      {photo.tags.length > 3 && (
                        <span class="rounded-full bg-white/15 px-2 py-0.5 text-[11px] text-white/80 backdrop-blur-sm">+{photo.tags.length - 3}</span>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </button>
            <a
              href={withBase(`photo/${photo.id}/`)}
              class="pointer-events-none absolute right-3 top-3 z-10 flex h-8 w-8 items-center justify-center rounded-full bg-white/10 opacity-0 backdrop-blur-md transition-all duration-medium group-hover:pointer-events-auto group-hover:opacity-100"
              aria-label={`View details for ${photo.title}`}
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17L17 7"/><path d="M7 7h10v10"/></svg>
            </a>
          </article>
        ))}
      </div>
    ) : (
      <div class="rounded-xl border border-dashed border-white/20 bg-surface/40 px-6 py-12 text-center">
        <p class="font-display text-2xl text-text">No photos yet</p>
        <p class="mx-auto mt-3 max-w-xl text-sm leading-7 text-muted">
          Add your first image with <code class="rounded bg-black/40 px-2 py-1 text-accent">bun run add-photo -- --input /path/to/image.jpg --title "My Shot"</code>.
        </p>
      </div>
    )
  }

  <p id="empty-filter-state" class="mt-6 hidden rounded-xl border border-dashed border-white/20 bg-surface/40 px-6 py-8 text-center text-muted">
    No photos match this tag.
  </p>
</section>

<PhotoLightbox />

<script id="photo-data" type="application/json" is:inline set:html={serializedPhotos}></script>
<script is:inline>
  // @ts-nocheck
  const el = (id) => document.getElementById(id);

  const photosDataElement = el("photo-data");
  const photosData = photosDataElement?.textContent ? JSON.parse(photosDataElement.textContent) : [];
  const photosById = new Map(photosData.map((photo) => [String(photo.id), photo]));

  const cards = Array.from(document.querySelectorAll("[data-photo-card]"));
  const emptyFilterState = el("empty-filter-state");
  const tagPills = Array.from(document.querySelectorAll(".tag-pill"));

  const dialog = el("photo-lightbox");
  const dialogImage = el("lightbox-image");
  const dialogTitle = el("lightbox-title");
  const dialogDescription = el("lightbox-description");
  const dialogDate = el("lightbox-date");
  const dialogLocation = el("lightbox-location");
  const dialogCamera = el("lightbox-camera");
  const dialogLens = el("lightbox-lens");
  const dialogAperture = el("lightbox-aperture");
  const dialogShutter = el("lightbox-shutter");
  const dialogIso = el("lightbox-iso");
  const dialogFocalLength = el("lightbox-focal-length");
  const dialogPosition = el("lightbox-position");
  const prevButton = el("lightbox-prev");
  const nextButton = el("lightbox-next");
  const closeButton = el("lightbox-close");
  const mediaContainer = el("lightbox-media-container");

  if (!dialog || !dialogImage) {
    throw new Error("Required gallery elements are missing from the DOM.");
  }

  let filteredPhotoIds = [];
  let activeIndex = -1;
  let activeTag = "";
  let touchStartX = null;
  let touchEndX = null;

  const activePillClasses = "border-accent bg-accent/15 text-accent";
  const inactivePillClasses = "border-white/15 text-muted";

  const setActiveTag = (tag) => {
    activeTag = tag;
    tagPills.forEach((pill) => {
      const isActive = pill.getAttribute("data-tag") === tag;
      pill.setAttribute("aria-pressed", String(isActive));
      pill.className = pill.className
        .replace(/border-accent|bg-accent\/15|text-accent|border-white\/15|text-muted/g, "")
        .trim();
      pill.classList.add(...(isActive ? activePillClasses : inactivePillClasses).split(" "));
    });
  };

  const updateURL = () => {
    const params = new URLSearchParams();
    if (activeTag) params.set("tag", activeTag);
    const next = `${window.location.pathname}${params.toString() ? `?${params.toString()}` : ""}`;
    window.history.replaceState({}, "", next);
  };

  const applyFilter = () => {
    filteredPhotoIds = [];

    cards.forEach((card) => {
      const tags = (card.getAttribute("data-tags") ?? "").split("|").filter(Boolean);
      const isVisible = !activeTag || tags.includes(activeTag);

      card.classList.toggle("hidden", !isVisible);
      if (isVisible) {
        const id = card.getAttribute("data-photo-id");
        if (id) filteredPhotoIds.push(id);
      }
    });

    if (emptyFilterState) {
      emptyFilterState.classList.toggle("hidden", filteredPhotoIds.length !== 0 || photosData.length === 0);
    }

    updateURL();
  };

  const readFromURL = () => {
    const params = new URLSearchParams(window.location.search);
    const tag = params.get("tag") ?? "";
    setActiveTag(tag);
  };

  const fill = (element, value) => {
    if (!element) return;
    element.textContent = value || "â€”";
  };

  const renderActivePhoto = () => {
    if (activeIndex < 0 || activeIndex >= filteredPhotoIds.length) return;
    const currentId = filteredPhotoIds[activeIndex];
    const currentPhoto = photosById.get(currentId);
    if (!currentPhoto) return;

    dialogImage.setAttribute("src", currentPhoto.full.src);
    dialogImage.setAttribute("alt", currentPhoto.title);
    fill(dialogTitle, currentPhoto.title);
    fill(dialogDescription, currentPhoto.description);
    fill(dialogDate, new Date(currentPhoto.publishedAt).toLocaleDateString());
    fill(dialogLocation, currentPhoto.location);
    fill(dialogCamera, currentPhoto.camera);
    fill(dialogLens, currentPhoto.lens);
    fill(dialogAperture, currentPhoto.aperture);
    fill(dialogShutter, currentPhoto.shutter);
    fill(dialogIso, currentPhoto.iso);
    fill(dialogFocalLength, currentPhoto.focalLength);
    fill(dialogPosition, `${activeIndex + 1} / ${filteredPhotoIds.length}`);
  };

  const openLightbox = (photoId) => {
    if (filteredPhotoIds.length === 0) return;
    activeIndex = filteredPhotoIds.indexOf(photoId);
    if (activeIndex < 0) activeIndex = 0;
    renderActivePhoto();
    dialog.showModal();
    document.body.style.overflow = "hidden";
  };

  const closeLightbox = () => {
    dialog.close();
    document.body.style.overflow = "";
    activeIndex = -1;
  };

  const stepLightbox = (delta) => {
    if (filteredPhotoIds.length <= 1) return;
    activeIndex = (activeIndex + delta + filteredPhotoIds.length) % filteredPhotoIds.length;
    renderActivePhoto();
  };

  document.querySelectorAll("[data-open-lightbox]").forEach((button) => {
    button.addEventListener("click", () => {
      const id = button.getAttribute("data-open-lightbox");
      if (!id) return;
      openLightbox(id);
    });
  });

  tagPills.forEach((pill) => {
    pill.addEventListener("click", () => {
      setActiveTag(pill.getAttribute("data-tag") ?? "");
      applyFilter();
    });
  });

  prevButton?.addEventListener("click", () => stepLightbox(-1));
  nextButton?.addEventListener("click", () => stepLightbox(1));
  closeButton?.addEventListener("click", closeLightbox);
  dialog.addEventListener("click", (event) => {
    if (event.target === dialog) closeLightbox();
  });
  dialog.addEventListener("close", () => {
    document.body.style.overflow = "";
  });

  document.addEventListener("keydown", (event) => {
    if (!dialog.open) return;
    if (event.key === "Escape") closeLightbox();
    if (event.key === "ArrowLeft") stepLightbox(-1);
    if (event.key === "ArrowRight") stepLightbox(1);
  });

  mediaContainer?.addEventListener("touchstart", (event) => {
    touchStartX = event.changedTouches[0]?.screenX ?? null;
  });
  mediaContainer?.addEventListener("touchend", (event) => {
    touchEndX = event.changedTouches[0]?.screenX ?? null;
    if (touchStartX == null || touchEndX == null) return;
    const delta = touchStartX - touchEndX;
    if (Math.abs(delta) < 50) return;
    if (delta > 0) stepLightbox(1);
    if (delta < 0) stepLightbox(-1);
  });

  readFromURL();
  applyFilter();

  const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  if (!prefersReducedMotion) {
    const animElements = document.querySelectorAll("[data-animate]");
    let visibleIndex = 0;
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const el = entry.target;
          el.style.transitionDelay = `${(visibleIndex % 4) * 80}ms`;
          visibleIndex++;
          el.classList.add("is-visible");
          observer.unobserve(el);
        }
      });
    }, { threshold: 0.08 });
    animElements.forEach((el) => observer.observe(el));
  } else {
    document.querySelectorAll("[data-animate]").forEach((el) => el.classList.add("is-visible"));
  }
</script>
