---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import SiteHeader from "@/components/SiteHeader.astro";
import SiteFooter from "@/components/SiteFooter.astro";
import GalleryExperience from "@/components/gallery/GalleryExperience.astro";
import { siteConfig } from "@/config/site";
import type { PhotoViewModel } from "@/types/photo";
import { withBase } from "@/utils/withBase";

const entries = await getCollection("photos").catch(() => []);
const sortedEntries = entries.sort(
  (a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime()
);

const photos: PhotoViewModel[] = sortedEntries.map((entry) => {
  const thumb = entry.data.thumbnail ?? entry.data.image;
  return {
    id: entry.slug,
    title: entry.data.title,
    description: entry.data.description ?? "Untitled frame.",
    publishedAt: entry.data.publishedAt.toISOString(),
    year: String(entry.data.publishedAt.getFullYear()),
    tags: entry.data.tags,
    location: entry.data.location ?? "",
    camera: entry.data.camera ?? "",
    lens: entry.data.lens ?? "",
    aperture: entry.data.settings?.aperture ?? "",
    shutter: entry.data.settings?.shutter ?? "",
    iso: entry.data.settings?.iso ? String(entry.data.settings.iso) : "",
    focalLength: entry.data.settings?.focalLength ?? "",
    featured: entry.data.featured,
    thumbnail: {
      src: thumb.src,
      width: thumb.width,
      height: thumb.height
    },
    full: {
      src: entry.data.image.src,
      width: entry.data.image.width,
      height: entry.data.image.height
    }
  };
});

const tags = Array.from(new Set(photos.flatMap((photo) => photo.tags))).sort();
const featuredPhoto = photos.find((photo) => photo.featured) ?? photos[0];
---

<BaseLayout
  title={`${siteConfig.title} | Portfolio`}
  description={siteConfig.subtitle}
  ogImage={featuredPhoto ? withBase(`social/${featuredPhoto.id}.svg`) : withBase("social/og-default.svg")}
>
  <SiteHeader />

  <main>
    <section class="mx-auto w-full max-w-7xl px-5 pt-12 md:px-8 md:pt-16">
      <p data-animate class="text-xs tracking-[0.24em] text-muted uppercase">Photography Portfolio</p>
      <h1 data-animate class="mt-3 max-w-2xl font-display text-4xl leading-tight text-text md:text-6xl" style="transition-delay: 80ms">
        Cinematic moments. Minimal presentation.
      </h1>
      <p data-animate class="mt-4 max-w-xl text-sm leading-7 text-muted md:text-base" style="transition-delay: 160ms">
        A curated collection of visual stories by {siteConfig.author}.
      </p>
    </section>

    <script is:inline>
      {
        const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        const heroElements = document.querySelectorAll("section [data-animate]");
        if (prefersReducedMotion) {
          heroElements.forEach((el) => el.classList.add("is-visible"));
        } else {
          const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("is-visible");
                observer.unobserve(entry.target);
              }
            });
          }, { threshold: 0.1 });
          heroElements.forEach((el) => observer.observe(el));
        }
      }
    </script>

    <GalleryExperience photos={photos} tags={tags} />
  </main>

  <SiteFooter />
</BaseLayout>
