---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import SiteHeader from "@/components/SiteHeader.astro";
import SiteFooter from "@/components/SiteFooter.astro";
import { siteConfig } from "@/config/site";
import { withBase } from "@/utils/withBase";

const entries = await getCollection("photos").catch(() => []);

const totalPhotos = entries.length;

const cameraMap = new Map<string, number>();
entries.forEach((e) => {
  const cam = e.data.camera;
  if (cam) cameraMap.set(cam, (cameraMap.get(cam) ?? 0) + 1);
});
const cameras = Array.from(cameraMap.entries())
  .sort((a, b) => b[1] - a[1]);

const tagMap = new Map<string, number>();
entries.forEach((e) => {
  e.data.tags.forEach((tag) => tagMap.set(tag, (tagMap.get(tag) ?? 0) + 1));
});
const topTags = Array.from(tagMap.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 16);

const years = entries.map((e) => e.data.publishedAt.getFullYear());
const yearRange = years.length > 0
  ? `${Math.min(...years)}–${Math.max(...years)}`
  : "—";

const topCamera = cameras.length > 0 ? cameras[0][0] : "—";
---

<BaseLayout title={`About | ${siteConfig.title}`} description={siteConfig.footer.bio}>
  <SiteHeader />

  <main class="mx-auto w-full max-w-6xl px-5 py-12 md:px-8 md:py-20">
    <!-- Hero -->
    <div class="relative" data-animate>
      <div class="absolute -left-4 top-2 h-20 w-20 rounded-full bg-accent/20 blur-2xl md:-left-8 md:h-28 md:w-28" aria-hidden="true" />
      <p class="relative text-xs tracking-[0.24em] text-muted uppercase">About</p>
      <h1 class="relative mt-3 max-w-3xl font-display text-5xl leading-tight text-text md:text-7xl">
        Photography with intent.
      </h1>
    </div>

    <!-- Bio + Stats -->
    <div class="mt-12 grid gap-10 md:grid-cols-[1.4fr_1fr] md:gap-14" data-animate style="transition-delay: 100ms">
      <div class="space-y-5">
        <p class="text-base leading-8 text-muted md:text-lg md:leading-9">
          {siteConfig.footer.bio} I built this portfolio as a fast, clean, and distraction-free space to share frames that matter to me.
          Every image includes capture metadata and contextual notes to make the story behind the shot as discoverable as the photo itself.
        </p>
        <p class="text-base leading-8 text-muted md:text-lg md:leading-9">
          This site runs on Astro with a file-based workflow so new photographs can be published quickly while keeping full ownership of assets and metadata.
        </p>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="rounded-xl border border-white/10 bg-surface/70 p-5">
          <p class="text-xs tracking-[0.2em] text-muted uppercase">Photos</p>
          <p class="mt-2 font-display text-4xl text-text">{totalPhotos}</p>
        </div>
        <div class="rounded-xl border border-white/10 bg-surface/70 p-5">
          <p class="text-xs tracking-[0.2em] text-muted uppercase">Years</p>
          <p class="mt-2 font-display text-4xl text-text">{yearRange}</p>
        </div>
        <div class="col-span-2 rounded-xl border border-white/10 bg-surface/70 p-5">
          <p class="text-xs tracking-[0.2em] text-muted uppercase">Favorite Camera</p>
          <p class="mt-2 font-display text-2xl text-text">{topCamera}</p>
        </div>
      </div>
    </div>

    <!-- Equipment section -->
    {cameras.length > 0 && (
      <section class="mt-16 border-t border-white/10 pt-10" data-animate style="transition-delay: 180ms">
        <h2 class="font-display text-3xl text-text">Equipment</h2>
        <p class="mt-2 text-sm text-muted">Cameras used across the collection.</p>
        <div class="mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {cameras.map(([name, count]) => (
            <div class="flex items-center justify-between rounded-xl border border-white/10 bg-surface/60 p-4">
              <span class="font-medium text-text">{name}</span>
              <span class="rounded-full bg-white/5 px-3 py-1 text-xs text-muted">{count} {count === 1 ? "photo" : "photos"}</span>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Tags cloud -->
    {topTags.length > 0 && (
      <section class="mt-16 border-t border-white/10 pt-10" data-animate style="transition-delay: 240ms">
        <h2 class="font-display text-3xl text-text">Themes</h2>
        <p class="mt-2 text-sm text-muted">Browse the collection by mood and subject.</p>
        <div class="mt-6 flex flex-wrap gap-2.5">
          {topTags.map(([tag, count]) => {
            const size = count >= 8 ? "text-base px-5 py-2.5" : count >= 4 ? "text-sm px-4 py-2" : "text-xs px-3 py-1.5";
            return (
              <a
                href={`${withBase()}?tag=${encodeURIComponent(tag)}`}
                class={`rounded-full border border-white/15 text-muted transition-colors hover:border-accent/40 hover:text-accent ${size}`}
              >
                {tag}
                <span class="ml-1.5 text-[10px] opacity-50">{count}</span>
              </a>
            );
          })}
        </div>
      </section>
    )}

    <!-- CTA -->
    <div class="mt-16 border-t border-white/10 pt-10 text-center" data-animate style="transition-delay: 300ms">
      <p class="font-display text-2xl text-text">Ready to explore?</p>
      <p class="mx-auto mt-2 max-w-md text-sm text-muted">
        Open any shot in the lightbox to see the full story behind each frame.
      </p>
      <a
        href={withBase()}
        class="mt-6 inline-flex items-center gap-2 rounded-full bg-accent px-6 py-3 text-sm font-semibold text-black transition-transform hover:scale-[1.03] active:scale-[0.98]"
      >
        Explore the gallery
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
      </a>
    </div>
  </main>

  <script is:inline>
    {
      const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const elements = document.querySelectorAll("[data-animate]");
      if (prefersReducedMotion) {
        elements.forEach((el) => el.classList.add("is-visible"));
      } else {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.05 });
        elements.forEach((el) => observer.observe(el));
      }
    }
  </script>
  <SiteFooter />
</BaseLayout>
